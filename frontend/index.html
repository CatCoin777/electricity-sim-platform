<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µåŠ›å¸‚åœºä»¿çœŸå¹³å°</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 40px;
            width: 400px;
        }
        .main-container {
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        .sidebar {
            background: #2c3e50;
            color: white;
            min-height: 100vh;
        }
        .sidebar .nav-link {
            color: #ecf0f1;
            padding: 12px 20px;
            border-radius: 5px;
            margin: 2px 0;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: #34495e;
            color: white;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
            padding: 20px;
        }
        .bid-form {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
        }
        .result-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 15px 0;
            padding: 20px;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-danger { background-color: #f8d7da; color: #721c24; }
        .status-warning { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç™»å½•ç•Œé¢ -->
        <div v-if="!isLoggedIn" class="login-container">
            <div class="login-card">
                <h2 class="text-center mb-4">ç”µåŠ›å¸‚åœºä»¿çœŸå¹³å°</h2>
                <form @submit.prevent="login">
                    <div class="mb-3">
                        <label class="form-label">ç”¨æˆ·å</label>
                        <input type="text" class="form-control" v-model="loginForm.username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å¯†ç </label>
                        <input type="password" class="form-control" v-model="loginForm.password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">è§’è‰²</label>
                        <select class="form-select" v-model="loginForm.role">
                            <option value="student">å­¦ç”Ÿ</option>
                            <option value="teacher">æ•™å¸ˆ</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">ç™»å½•</button>
                    <div class="text-center mt-3">
                        <a href="#" @click="showRegister = true">æ³¨å†Œæ–°ç”¨æˆ·</a>
                    </div>
                </form>
                
                <!-- æ³¨å†Œè¡¨å• -->
                <div v-if="showRegister" class="mt-4 pt-3 border-top">
                    <h5>æ³¨å†Œæ–°ç”¨æˆ·</h5>
                    <form @submit.prevent="register">
                        <div class="mb-3">
                            <label class="form-label">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" v-model="registerForm.username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å¯†ç </label>
                            <input type="password" class="form-control" v-model="registerForm.password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å§“å</label>
                            <input type="text" class="form-control" v-model="registerForm.full_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è§’è‰²</label>
                            <select class="form-select" v-model="registerForm.role">
                                <option value="student">å­¦ç”Ÿ</option>
                                <option value="teacher">æ•™å¸ˆ</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100">æ³¨å†Œ</button>
                        <button type="button" class="btn btn-link w-100" @click="showRegister = false">è¿”å›ç™»å½•</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div v-else class="main-container">
            <div class="container-fluid">
                <div class="row">
                    <!-- ä¾§è¾¹æ  -->
                    <div class="col-md-2 sidebar">
                        <div class="p-3">
                            <h5>ç”µåŠ›å¸‚åœºä»¿çœŸ</h5>
                            <p class="small">æ¬¢è¿, {{ currentUser.full_name }}</p>
                        </div>
                        <nav class="nav flex-column">
                            <a class="nav-link" :class="{active: currentView === 'dashboard'}" @click="currentView = 'dashboard'">
                                ğŸ“Š ä»ªè¡¨æ¿
                            </a>
                            <a class="nav-link" :class="{active: currentView === 'scenarios'}" @click="currentView = 'scenarios'">
                                ğŸ“‹ å®éªŒåœºæ™¯
                            </a>
                            <a class="nav-link" :class="{active: currentView === 'bidding'}" @click="currentView = 'bidding'">
                                ğŸ’° ç«ä»·æäº¤
                            </a>
                            <a class="nav-link" :class="{active: currentView === 'results'}" @click="currentView = 'results'">
                                ğŸ“ˆ ç»“æœåˆ†æ
                            </a>
                            <a v-if="currentUser.role === 'teacher'" class="nav-link" :class="{active: currentView === 'admin'}" @click="currentView = 'admin'">
                                âš™ï¸ ç®¡ç†é¢æ¿
                            </a>
                            <a class="nav-link" @click="logout">
                                ğŸšª é€€å‡ºç™»å½•
                            </a>
                        </nav>
                    </div>

                    <!-- ä¸»å†…å®¹åŒº -->
                    <div class="col-md-10 p-4">
                        <!-- ä»ªè¡¨æ¿ -->
                        <div v-if="currentView === 'dashboard'">
                            <h2>ä»ªè¡¨æ¿</h2>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="result-card text-center">
                                        <h4>{{ scenarios.length }}</h4>
                                        <p>å¯ç”¨åœºæ™¯</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="result-card text-center">
                                        <h4>{{ myBids.length }}</h4>
                                        <p>æˆ‘çš„ç«ä»·</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="result-card text-center">
                                        <h4>{{ completedScenarios.length }}</h4>
                                        <p>å·²å®Œæˆ</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="result-card text-center">
                                        <h4>{{ totalProfit.toFixed(2) }}</h4>
                                        <p>æ€»æ”¶ç›Š</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å®éªŒåœºæ™¯ -->
                        <div v-if="currentView === 'scenarios'">
                            <h2>å®éªŒåœºæ™¯</h2>
                            <div class="row">
                                <div v-for="scenario in scenarios" :key="scenario.scenario_id" class="col-md-6 mb-3">
                                    <div class="result-card">
                                        <h5>{{ scenario.scenario_id }}</h5>
                                        <p><strong>éœ€æ±‚é‡:</strong> {{ scenario.demand }} MW</p>
                                        <p><strong>å‚ä¸è€…:</strong> {{ scenario.participants.join(', ') }}</p>
                                        <p><strong>å¯ç”¨æœºåˆ¶:</strong></p>
                                        <div class="mb-3">
                                            <span v-for="mechanism in scenario.enabled_mechanisms" 
                                                  :key="mechanism" 
                                                  class="badge bg-primary me-1">
                                                {{ getMechanismName(mechanism) }}
                                            </span>
                                        </div>
                                        <button class="btn btn-primary" @click="selectScenario(scenario)">
                                            å¼€å§‹å®éªŒ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç«ä»·æäº¤ -->
                        <div v-if="currentView === 'bidding'">
                            <h2>ç«ä»·æäº¤</h2>
                            <div v-if="selectedScenario" class="bid-form">
                                <h4>åœºæ™¯: {{ selectedScenario.scenario_id }}</h4>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">æŠ¥ä»· (å…ƒ/MWh)</label>
                                            <input type="number" step="0.01" class="form-control" v-model="bidForm.offer">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">æˆæœ¬ (å…ƒ/MWh)</label>
                                            <input type="number" step="0.01" class="form-control" v-model="bidForm.cost">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">å›ºå®šæˆæœ¬ (å…ƒ)</label>
                                            <input type="number" step="0.01" class="form-control" v-model="bidForm.fixed_cost">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">å¸‚åœºæœºåˆ¶</label>
                                            <select class="form-select" v-model="selectedMechanism">
                                                <option v-for="mechanism in selectedScenario.enabled_mechanisms" 
                                                        :key="mechanism" :value="mechanism">
                                                    {{ getMechanismName(mechanism) }}
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-success" @click="submitBid">æäº¤ç«ä»·</button>
                                <button class="btn btn-secondary ms-2" @click="calculateResult">æŸ¥çœ‹ç»“æœ</button>
                            </div>
                            <div v-else class="text-center">
                                <p>è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®éªŒåœºæ™¯</p>
                            </div>
                        </div>

                        <!-- ç»“æœåˆ†æ -->
                        <div v-if="currentView === 'results'">
                            <h2>ç»“æœåˆ†æ</h2>
                            <div v-if="simulationResult" class="chart-container">
                                <h4>å‡ºæ¸…ç»“æœ</h4>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div id="priceChart" style="height: 300px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="profitChart" style="height: 300px;"></div>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <h5>è¯¦ç»†ç»“æœ</h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>å‚ä¸è€…</th>
                                                    <th>çŠ¶æ€</th>
                                                    <th>æ”¶ç›Š (å…ƒ)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="(dispatched, student) in simulationResult.dispatched" :key="student">
                                                    <td>{{ student }}</td>
                                                    <td>
                                                        <span :class="dispatched ? 'status-badge status-success' : 'status-badge status-danger'">
                                                            {{ dispatched ? 'ä¸­æ ‡' : 'æœªä¸­æ ‡' }}
                                                        </span>
                                                    </td>
                                                    <td>{{ simulationResult.profits[student] }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="alert alert-info">
                                        <strong>å‡ºæ¸…ä»·æ ¼:</strong> {{ simulationResult.clearing_price }} å…ƒ/MWh
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center">
                                <p>æš‚æ— ç»“æœæ•°æ®</p>
                            </div>
                        </div>

                        <!-- ç®¡ç†é¢æ¿ -->
                        <div v-if="currentView === 'admin' && currentUser.role === 'teacher'">
                            <h2>ç®¡ç†é¢æ¿</h2>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="bid-form">
                                        <h4>åˆ›å»ºæ–°åœºæ™¯</h4>
                                        <div class="mb-3">
                                            <label class="form-label">åœºæ™¯ID</label>
                                            <input type="text" class="form-control" v-model="newScenario.scenario_id">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">éœ€æ±‚é‡ (MW)</label>
                                            <input type="number" class="form-control" v-model="newScenario.demand">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">å‚ä¸è€… (ç”¨é€—å·åˆ†éš”)</label>
                                            <input type="text" class="form-control" v-model="newScenario.participants">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">å¯ç”¨æœºåˆ¶</label>
                                            <div v-for="mechanism in availableMechanisms" :key="mechanism.value">
                                                <input type="checkbox" :value="mechanism.value" v-model="newScenario.enabled_mechanisms">
                                                <label>{{ mechanism.name }}</label>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary" @click="createScenario">åˆ›å»ºåœºæ™¯</button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="bid-form">
                                        <h4>å­¦ç”Ÿè¿›åº¦</h4>
                                        <div v-for="scenario in scenarios" :key="scenario.scenario_id">
                                            <h6>{{ scenario.scenario_id }}</h6>
                                            <div class="progress mb-2">
                                                <div class="progress-bar" :style="{width: getProgressPercentage(scenario) + '%'}">
                                                    {{ getProgressPercentage(scenario) }}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    isLoggedIn: false,
                    currentUser: null,
                    currentView: 'dashboard',
                    showRegister: false,
                    
                    // ç™»å½•è¡¨å•
                    loginForm: {
                        username: '',
                        password: '',
                        role: 'student'
                    },
                    
                    // æ³¨å†Œè¡¨å•
                    registerForm: {
                        username: '',
                        password: '',
                        full_name: '',
                        role: 'student'
                    },
                    
                    // åœºæ™¯æ•°æ®
                    scenarios: [],
                    selectedScenario: null,
                    selectedMechanism: 'uniform_price',
                    
                    // ç«ä»·è¡¨å•
                    bidForm: {
                        offer: 0,
                        cost: 0,
                        fixed_cost: 0
                    },
                    
                    // ä»¿çœŸç»“æœ
                    simulationResult: null,
                    
                    // æ–°åœºæ™¯è¡¨å•
                    newScenario: {
                        scenario_id: '',
                        demand: 0,
                        participants: '',
                        enabled_mechanisms: ['uniform_price']
                    },
                    
                    // å¯ç”¨æœºåˆ¶
                    availableMechanisms: [
                        { value: 'uniform_price', name: 'ç»Ÿä¸€ä»·æ ¼æœºåˆ¶' },
                        { value: 'pay_as_bid', name: 'æŒ‰æŠ¥ä»·æ”¯ä»˜æœºåˆ¶' },
                        { value: 'fixed_cost_uniform', name: 'å›ºå®šæˆæœ¬ç»Ÿä¸€ä»·æ ¼' },
                        { value: 'fixed_cost_pay_as_bid', name: 'å›ºå®šæˆæœ¬æŒ‰æŠ¥ä»·æ”¯ä»˜' },
                        { value: 'zone_limit_uniform', name: 'åŒºåŸŸé™åˆ¶ç»Ÿä¸€ä»·æ ¼' },
                        { value: 'constrained_on', name: 'è¡¥å¿æœºåˆ¶' },
                        { value: 'risk_adjusted_uniform', name: 'é£é™©è°ƒæ•´ç»Ÿä¸€ä»·æ ¼' },
                        { value: 'two_stage', name: 'äºŒé˜¶æ®µå¸‚åœº' }
                    ],
                    
                    // æˆ‘çš„ç«ä»·
                    myBids: []
                }
            },
            
            computed: {
                completedScenarios() {
                    return this.scenarios.filter(s => this.myBids.some(b => b.scenario_id === s.scenario_id));
                },
                
                totalProfit() {
                    return this.myBids.reduce((sum, bid) => sum + (bid.profit || 0), 0);
                }
            },
            
            mounted() {
                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                const token = localStorage.getItem('token');
                if (token) {
                    this.isLoggedIn = true;
                    this.loadUserData();
                    this.loadScenarios();
                }
                
                // è®¾ç½®axiosé»˜è®¤é…ç½®
                axios.defaults.baseURL = 'http://127.0.0.1:8000';
            },
            
            methods: {
                async login() {
                    try {
                        const response = await axios.post('/api/auth/login', this.loginForm);
                        localStorage.setItem('token', response.data.access_token);
                        localStorage.setItem('userRole', response.data.role);
                        this.isLoggedIn = true;
                        this.loadUserData();
                        this.loadScenarios();
                        this.currentView = 'dashboard';
                    } catch (error) {
                        alert('ç™»å½•å¤±è´¥: ' + error.response?.data?.detail || 'æœªçŸ¥é”™è¯¯');
                    }
                },
                
                async register() {
                    try {
                        const response = await axios.post('/api/auth/register', {
                            username: this.registerForm.username,
                            password: this.registerForm.password,
                            full_name: this.registerForm.full_name,
                            role: this.registerForm.role
                        });
                        alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
                        this.showRegister = false;
                    } catch (error) {
                        alert('æ³¨å†Œå¤±è´¥: ' + error.response?.data?.detail || 'æœªçŸ¥é”™è¯¯');
                    }
                },
                
                logout() {
                    localStorage.removeItem('token');
                    localStorage.removeItem('userRole');
                    this.isLoggedIn = false;
                    this.currentUser = null;
                },
                
                async loadUserData() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await axios.get('/api/users/me', {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        this.currentUser = response.data;
                    } catch (error) {
                        console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                    }
                },
                
                async loadScenarios() {
                    try {
                        // è¿™é‡Œåº”è¯¥è°ƒç”¨APIè·å–åœºæ™¯åˆ—è¡¨
                        // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                        this.scenarios = [
                            {
                                scenario_id: 'lesson01',
                                demand: 3,
                                participants: ['alice', 'bob', 'charlie', 'dave'],
                                enabled_mechanisms: ['uniform_price', 'pay_as_bid']
                            }
                        ];
                    } catch (error) {
                        console.error('åŠ è½½åœºæ™¯å¤±è´¥:', error);
                    }
                },
                
                selectScenario(scenario) {
                    this.selectedScenario = scenario;
                    this.selectedMechanism = scenario.enabled_mechanisms[0];
                    this.currentView = 'bidding';
                },
                
                async submitBid() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await axios.post('/simulation/bid', {
                            scenario_id: this.selectedScenario.scenario_id,
                            student_id: this.currentUser.username,
                            bid: this.bidForm
                        }, {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        
                        alert('ç«ä»·æäº¤æˆåŠŸï¼');
                        this.calculateResult();
                    } catch (error) {
                        alert('ç«ä»·æäº¤å¤±è´¥: ' + error.response?.data?.detail || 'æœªçŸ¥é”™è¯¯');
                    }
                },
                
                async calculateResult() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await axios.get(`/simulation/result/${this.selectedScenario.scenario_id}`, {
                            params: { type: this.selectedMechanism },
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        
                        this.simulationResult = response.data;
                        this.currentView = 'results';
                        this.$nextTick(() => {
                            this.renderCharts();
                        });
                    } catch (error) {
                        alert('è·å–ç»“æœå¤±è´¥: ' + error.response?.data?.detail || 'æœªçŸ¥é”™è¯¯');
                    }
                },
                
                renderCharts() {
                    // ä»·æ ¼å›¾è¡¨
                    const priceChart = echarts.init(document.getElementById('priceChart'));
                    const priceOption = {
                        title: { text: 'å‡ºæ¸…ä»·æ ¼åˆ†æ' },
                        tooltip: {},
                        xAxis: { type: 'category', data: ['å‡ºæ¸…ä»·æ ¼'] },
                        yAxis: { type: 'value' },
                        series: [{
                            name: 'ä»·æ ¼',
                            type: 'bar',
                            data: [this.simulationResult.clearing_price]
                        }]
                    };
                    priceChart.setOption(priceOption);
                    
                    // æ”¶ç›Šå›¾è¡¨
                    const profitChart = echarts.init(document.getElementById('profitChart'));
                    const profitData = Object.entries(this.simulationResult.profits).map(([name, profit]) => ({
                        name,
                        value: profit
                    }));
                    const profitOption = {
                        title: { text: 'å‚ä¸è€…æ”¶ç›Š' },
                        tooltip: {},
                        series: [{
                            name: 'æ”¶ç›Š',
                            type: 'pie',
                            data: profitData
                        }]
                    };
                    profitChart.setOption(profitOption);
                },
                
                getMechanismName(mechanism) {
                    const found = this.availableMechanisms.find(m => m.value === mechanism);
                    return found ? found.name : mechanism;
                },
                
                async createScenario() {
                    try {
                        const token = localStorage.getItem('token');
                        const scenarioData = {
                            scenario_id: this.newScenario.scenario_id,
                            demand: parseInt(this.newScenario.demand),
                            participants: this.newScenario.participants.split(',').map(p => p.trim()),
                            enabled_mechanisms: this.newScenario.enabled_mechanisms
                        };
                        
                        const response = await axios.post('/admin/scenario/create', scenarioData, {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        
                        alert('åœºæ™¯åˆ›å»ºæˆåŠŸï¼');
                        this.loadScenarios();
                        this.newScenario = {
                            scenario_id: '',
                            demand: 0,
                            participants: '',
                            enabled_mechanisms: ['uniform_price']
                        };
                    } catch (error) {
                        alert('åˆ›å»ºåœºæ™¯å¤±è´¥: ' + error.response?.data?.detail || 'æœªçŸ¥é”™è¯¯');
                    }
                },
                
                getProgressPercentage(scenario) {
                    // è®¡ç®—å­¦ç”Ÿæäº¤è¿›åº¦
                    const totalParticipants = scenario.participants.length;
                    const submittedBids = this.myBids.filter(b => b.scenario_id === scenario.scenario_id).length;
                    return Math.round((submittedBids / totalParticipants) * 100);
                }
            }
        }).mount('#app');
    </script>
</body>
</html> 